#!/bin/sh -eu

# configure-docker-proxy: configure Docker proxy settings
# Copyright (C) 2021  "Michael G. Morey" <mgmorey@gmail.com>

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

INPUT=-
OUTPUT=/etc/systemd/system/docker.service.d/http-proxy.conf

abort() {
    printf "$@" >&2
    exit 1
}

assert() {
    "$@" || abort "%s: Assertion failed: %s\n" "$0" "$*"
}

configure_docker_proxy()
{
    tmpfile=$(mktemp)
    trap "/bin/rm -f $tmpfile" EXIT INT QUIT TERM
    read_proxy_parameters | \
	grep -E '^(HTTP|NO)_PROXY=' | \
	print_proxy_configuration >$tmpfile

    if [ "$(wc -l <$tmpfile)" -gt 1 ]; then
	if [ "$output" != - -a -w "$output" ]; then
            mkdir -p "$(dirname "$output")"
            chmod a+r $tmpfile
            /bin/mv -f $tmpfile "$output"
            systemctl daemon-reload

	    if systemctl status docker >/dev/null; then
		systemctl restart docker
	    fi
	else
            cat $tmpfile
	fi
    fi
}

get_realpath() (
    assert [ $# -ge 1 ]
    realpath=$(which realpath || true)

    if [ -n "$realpath" ]; then
	$realpath "$@"
    else
	for file; do
	    if expr "$file" : '/.*' >/dev/null; then
		printf "%s\n" "$file"
	    else
		printf "%s\n" "$PWD/${file#./}"
	    fi
	done
    fi
)

is_valid_input_file() {
    case "$1" in
	(-)
	    true
	    ;;
	(*)
	    test -f "$1" -a -r "$1"
	    ;;
    esac
}

is_valid_output_file() {
    case "$1" in
	(-)
	    true
	    ;;
	(*)
	    if [ ! -e "$1" ]; then
		test -w "$(dirname "$1")"
	    elif [ -f "$1" ]; then
		test -w "$1"
	    else
		false
	    fi
	    ;;
    esac
}

parse_arguments() {
    input=$INPUT
    no_proxy=
    output=$OUTPUT
    proxy=

    while getopts i:n:o:h opt; do
	case $opt in
	    (i)
		input="$OPTARG"
		;;
	    (n)
		no_proxy="$OPTARG"
		;;
	    (o)
		output="$OPTARG"
		;;
	    (h)
		usage
		exit 0
		;;
	    (\?)
		exit 2
		;;
	esac
    done

    shift $(($OPTIND - 1))

    if [ $# -gt 0 ]; then
	proxy="$1"
	shift
    fi

    if [ $# -gt 0 ]; then
	usage_error "%s: Too many arguments\n" "$script"
    fi
}

parse_input_file() {
    if is_valid_input_file "$1"; then
	input="$1"
    else
	usage_error "%s: %s: Invalid input file\n" "$script" "$1"
    fi
}

parse_output_file() {
    if is_valid_output_file "$1"; then
	input="$1"
    else
	usage_error "%s: %s: Invalid output file\n" "$script" "$1"
    fi
}

print_proxy_configuration() {
    printf '[%s]\n' "Service"

    while read parameter; do
	printf 'Environment="%s"\n' "$parameter"
    done
}

read_proxy_parameters() {
    if [ -n "${proxy-}" ]; then
	"${script_prefix}generate-proxy-parameters" \
	    ${no_proxy:+-n "$no_proxy"} \
	    "$proxy"
    else
	case "$input" in
	    (-)
		cat
		;;
	    (*)
		cat "$input"
		;;
	esac
    fi
}

usage() {
    cat <<EOF >&2
Usage: $script [-n NO-PROXY] [-o OUTPUT] PROXY-URL
       $script [-i INPUT] [-o OUTPUT]
       $script -h
EOF
}

usage_error() {
    if [ $# -gt 0 ]; then
	printf "$@" >&2
    fi

    printf '%s\n' '' >&2
    usage
    exit 2
}

script=$(basename "$0")

case "$0" in
    (*/*)
	script_dir=$(get_realpath "$(dirname "$0")")
	;;
    (*)
	script_dir=
	;;
esac

script_prefix=${script_dir:+$script_dir/}

parse_arguments "$@"
configure_docker_proxy
