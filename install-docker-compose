#!/bin/sh -eu

# install-docker-compose: install Docker Compose from GitHub
# Copyright (C) 2020  "Michael G. Morey" <mgmorey@gmail.com>

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

BASE_URL=https://github.com/docker/compose/releases

COMPOSE_FILENAME=docker-compose
COMPOSE_VERSION=1.28.2

get_compose_target_file() {
    printf '%s/%s\n' "$prefix" bin/$COMPOSE_FILENAME
}

get_compose_version_number() {
    get_version_number $(get_compose_version_string "$@")
}

get_compose_version_string() {
    get_version_string "${1-$COMPOSE_FILENAME}" | cut -d, -f 1
}

get_version_number() {
    printf '%s\n' "$*" | awk '{print $3}'
}

get_version_string() {
    if [ -n "$1" -a -x "$1" ]; then
	"$1" --version || true
    fi
}

get_curl_options() {
    printf '%s\n' -L -f

    if [ "$bar" = true ]; then
	printf '%s\n' -#
    elif [ "$silent" = true ]; then
	printf '%s\n' -s
    fi
}

get_execmode() {
    case "$1" in
	($HOME/*)
	    printf '%s\n' a+rx
	    ;;
	(*)
	    printf '%s\n' u=rwx,go=rx
	    ;;
    esac
}

get_filetype() {
    system=$(uname -s)

    case "$system" in
	(CYGWIN_NT-*)
	    printf '%s\n' exe
	    ;;
	(MINGW64_NT-*)
	    printf '%s\n' exe
	    ;;
    esac
}

get_hardware() {
    uname -m
}

get_platform() {
    system=$(uname -s)

    case "$system" in
	(CYGWIN_NT-*)
	    printf '%s\n' Windows
	    ;;
	(MINGW64_NT-*)
	    printf '%s\n' Windows
	    ;;
	(*)
	    printf '%s\n' "$system"
	    ;;
    esac
}

get_url() {
    filetype=$(get_filetype)
    hardware=$(get_hardware)
    platform=$(get_platform)
    file="$COMPOSE_FILENAME-$platform-$hardware${filetype:+.$filetype}"
    dir="download/$COMPOSE_VERSION"
    url="$BASE_URL/$dir/$file"
    printf '%s\n' "$url"
}

install_docker_compose() {
    if [ -z "$prefix" ]; then
	if [ "$(id -u)" -eq 0 ]; then
	    prefix=/usr/local
	else
	    prefix=$HOME/.local
	fi
    fi

    target_file=$(get_compose_target_file)
    version_before=$(get_compose_version_number "$target_file")
    version_after=

    if [ $force = true -o "$version_before" != "$COMPOSE_VERSION" ]; then
	if install_target_file "$target_file"; then
	    version_after=$(get_compose_version_number "$target_file")
	fi
    fi

    if [ "$verbose" = true -o "$version_after" ]; then
	print_summary
    fi
}

install_target_file() {
    dir=$(dirname "$1")
    file=$(basename "$1")
    mode=$(get_execmode "$1")

    if [ ! -d "$dir" ]; then
	mkdir ${mode:+-m $mode }-p "$dir"
    fi

    tmpfile=$(mktemp -p "$dir" -t "$file.XXXXXXXXXX.tmp")
    trap "/bin/rm -f \"$tmpfile\"" EXIT INT QUIT TERM
    url=$(get_url)

    if [ "$silent" = false ]; then
	printf 'Downloading from %s\n' $(dirname "$url")
	printf '%s\n' ''
    fi

    if ! curl $(get_curl_options) "$url" -o "$tmpfile"; then
	return 1
    fi

    if [ ! -s "$tmpfile" ]; then
	return 1
    fi

    if [ "$silent" = false ]; then
	printf '%s\n' ''
	printf 'Installing %s %s as %s\n' \
	       "Docker Compose" \
	       "$COMPOSE_VERSION" \
	       "$1"
    fi

    if [ -n "$mode" ]; then
	chmod $mode "$tmpfile"
    fi

    /bin/mv -f "$tmpfile" "$1"
}

parse_arguments() {
    bar=false
    force=false
    prefix=
    silent=false
    verbose=false

    while getopts bfp:svh opt; do
	case $opt in
	    (b)
		bar=true
		;;
	    (f)
		force=true
		;;
	    (p)
		parse_prefix $OPTARG
		;;
	    (s)
		silent=true
		;;
	    (v)
		verbose=true
		;;
	    (h)
		usage
		exit 0
		;;
	    (\?)
		exit 2
		;;
	esac
    done

    shift $(($OPTIND - 1))

    if [ $# -gt 0 ]; then
	usage_error "%s: Too many arguments\n" "$script"
    fi
}

parse_prefix() {
    case "$1" in
	($HOME/.local|/opt/*|/usr/local)
	    prefix=$1
	    ;;
	(*)
	    usage_error "%s: %s: Invalid prefix\n" "$script" "$1"
	    ;;
    esac

    if [ ! -d "$prefix/bin" ]; then
	usage_error "%s: %s: Invalid prefix\n" "$script" "$1"
    elif [ ! -w "$prefix/bin" ]; then
	usage_error "%s: %s: Invalid prefix\n" "$script" "$1"
    fi
}

print_summary() {
    if [ "$silent" = true ]; then
	return 0
    fi

    if [ -n "$version_after" ]; then
	printf '%s\n' ''
    fi

    printf '%s\n' 'Installation Summary:'
    printf '%s\n' ''

    which -a $COMPOSE_FILENAME | while read file; do
	version_string=$(get_compose_version_string "$file")

	if [ "$file" = "$target_file" ]; then
	    if [ -z "$version_before" ]; then
		status=installed
	    elif [ "$version_after" = "$version_before" ]; then
		status=reinstalled
	    elif [ -n "$version_after" ]; then
		status="upgraded from $version_before"
	    else
		status=unchanged
	    fi
	else
	    status=unchanged
	fi

	printf '%s: %s\n' \
	       "$version_string" \
	       "$file${status:+ ($status)}"

    done | sed "s/$COMPOSE_FILENAME version/Docker Compose/"
}

usage() {
    cat <<EOF >&2
Usage: $script [-b] [-f] [-p PREFIX] [-s] [-v]
       $script -h
EOF
}

usage_error() {
    if [ $# -gt 0 ]; then
	printf "$@" >&2
    fi

    printf '%s\n' '' >&2
    usage
    exit 2
}

script=$(basename "$0")
parse_arguments "$@"
install_docker_compose
